@startuml
title Despliegue E-Commerce – Mon Amour Studio\n(Refleja docker-compose.yml real)

' Estética
skinparam ArrowThickness 2
skinparam componentStyle uml2
skinparam Shadowing false
skinparam dpi 150

node "Cliente (navegador)" as BROWSER

node "Host Contenedores" as HOST {
  folder "Docker Engine · Red: ecommerce_net (bridge)" {

    ' ── Reverse Proxy ───────────────────────────────────────────
    component "traefik\nTraefik v3.1 · Reverse Proxy\nHTTP :80 (exposed) · Dashboard :8080\nDocker provider · labels routing\nStripPrefix + AddPrefix middlewares" as TRAEFIK

    ' ── Frontend ────────────────────────────────────────────────
    component "frontend\nNext.js standalone\nport 3000 (interno)" as FRONT

    ' ── Microservicios ──────────────────────────────────────────
    folder "Microservicio Usuarios" {
      component "usuarios\nFastAPI · HTTP 8000\nenv: DATABASE_URL, REDIS_URL,\nJWT_SECRET, Kafka, OTLP, MinIO" as USERS_API
      database  "postgres-usuarios\nPostgreSQL 16-alpine\nDB: usuarios\nhealthcheck: pg_isready\nvol: pg_usuarios_data" as PG_USERS
    }

    folder "Microservicio Inventario" {
      component "inventario\nFastAPI · HTTP 8000 / gRPC 50052\nenv: DATABASE_URL, GRPC_PORT,\nKafka, OTLP, MinIO" as INVENTORY_API
      database  "postgres-inventario\nPostgreSQL 16-alpine\nDB: inventario\nvol: pg_inventario_data" as PG_INVENTORY
    }

    folder "Microservicio Pedidos" {
      component "pedidos\nFastAPI · HTTP 8000\nenv: DATABASE_URL, JWT_SECRET,\nKafka, OTLP, MinIO" as ORDERS_API
      database  "postgres-pedidos\nPostgreSQL 16-alpine\nDB: pedidos\nvol: pg_pedidos_data" as PG_ORDERS
    }

    folder "Microservicio Entregas" {
      component "entregas\nFastAPI · HTTP 8000 / gRPC 50054\nenv: DATABASE_URL, GRPC_PORT,\nKafka, OTLP, MinIO" as DELIVERIES_API
      database  "postgres-entregas\nPostgreSQL 16-alpine\nDB: entregas\nvol: pg_entregas_data" as PG_DELIVERIES
    }

    folder "Microservicio Campañas" {
      component "campanas\nFastAPI · HTTP 8000\nenv: DATABASE_URL,\nKafka, OTLP, MinIO" as CAMPAIGNS_API
      database  "postgres-campanas\nPostgreSQL 16-alpine\nDB: campanas\nvol: pg_campanas_data" as PG_CAMPAIGNS
    }

    ' ── Servicios compartidos ───────────────────────────────────
    folder "Servicios Compartidos" {
      component "redis\nRedis 7-alpine\nvol: redis_data" as REDIS
      component "minio\nminio/minio:latest\nserver /data --console :9001\nvol: minio_data" as MINIO
      component "minio-init\nminio/mc:latest\ncrea buckets: users, inventory,\norders, deliveries, campaigns" as MINIO_INIT
    }

    ' ── Event Bus ───────────────────────────────────────────────
    component "kafka\nbitnami/kafka:3.7\nKRaft (sin Zookeeper)\nPLAINTEXT :9092 / CONTROLLER :9093\nauto_create_topics=true\nvol: kafka_data" as KAFKA

    ' ── Observabilidad ──────────────────────────────────────────
    folder "Observabilidad" {
      component "prometheus\nprom/prometheus:v2.53.0\nscrape: usuarios, inventario,\npedidos, entregas, campanas\nvol: prometheus_data" as PROM
      component "grafana\ngrafana/grafana:11.1.0\nadmin/admin\ndatasources: Prometheus, Jaeger\nvol: grafana_data" as GRAFANA
      component "jaeger\njaegertracing/all-in-one:1.58\nOTLP collector habilitado" as JAEGER
    }
  }
}

' ── Acceso externo ──────────────────────────────────────────────
BROWSER --> TRAEFIK : "HTTP :80"
BROWSER ..> TRAEFIK : "Dashboard :8080"

' ── Traefik → Frontend (catch-all, priority 1) ─────────────────
TRAEFIK --> FRONT : "PathPrefix(`/`)\npriority 1 → :3000"

' ── Traefik → microservicios (path rewrite, priority 10) ───────
TRAEFIK --> USERS_API      : "/api/users/ →\nStripPrefix + AddPrefix\n→ /usuarios/"
TRAEFIK --> INVENTORY_API  : "/api/inventory/ →\nStripPrefix + AddPrefix\n→ /productos/"
TRAEFIK --> ORDERS_API     : "/api/orders/ →\nStripPrefix + AddPrefix\n→ /pedidos/"
TRAEFIK --> DELIVERIES_API : "/api/deliveries/ →\nStripPrefix + AddPrefix\n→ /entregas/"
TRAEFIK --> CAMPAIGNS_API  : "/api/campaigns/ →\nStripPrefix + AddPrefix\n→ /campanas/\n/api/publications/ → /publicaciones/"

' ── gRPC sync RPC ───────────────────────────────────────────────
ORDERS_API --> INVENTORY_API  : "gRPC :50052\nreservar stock"
ORDERS_API --> DELIVERIES_API : "gRPC :50054\nprogramar envío"

' ── Kafka event bus ─────────────────────────────────────────────
ORDERS_API    --> KAFKA : "pub: order.created\npub: payment.succeeded"
USERS_API     --> KAFKA : "pub: user.registered"
INVENTORY_API --> KAFKA : "pub: stock.reserved"
DELIVERIES_API --> KAFKA : "pub: entrega.programada"
CAMPAIGNS_API --> KAFKA : "pub: campana.activada"

KAFKA --> INVENTORY_API  : "sub: order.created\n→ reservar stock"
KAFKA --> DELIVERIES_API : "sub: payment.succeeded\n→ programar envío"
KAFKA --> CAMPAIGNS_API  : "sub: order.created,\npayment.succeeded\n→ analytics"

' ── Persistencia ────────────────────────────────────────────────
USERS_API      --> PG_USERS
INVENTORY_API  --> PG_INVENTORY
ORDERS_API     --> PG_ORDERS
DELIVERIES_API --> PG_DELIVERIES
CAMPAIGNS_API  --> PG_CAMPAIGNS

' ── Redis (sesiones usuarios) ───────────────────────────────────
USERS_API --> REDIS : "cache / sesiones"

' ── MinIO (Object Storage compartido) ───────────────────────────
MINIO_INIT --> MINIO : "mc mb buckets"
USERS_API      --> MINIO : "bucket: users"
INVENTORY_API  --> MINIO : "bucket: inventory"
ORDERS_API     --> MINIO : "bucket: orders"
DELIVERIES_API --> MINIO : "bucket: deliveries"
CAMPAIGNS_API  --> MINIO : "bucket: campaigns"

' ── Observabilidad: métricas ────────────────────────────────────
USERS_API      --> PROM : "/metrics"
INVENTORY_API  --> PROM : "/metrics"
ORDERS_API     --> PROM : "/metrics"
DELIVERIES_API --> PROM : "/metrics"
CAMPAIGNS_API  --> PROM : "/metrics"

' ── Observabilidad: trazas (OpenTelemetry → Jaeger OTLP) ──────
USERS_API      --> JAEGER : "OTLP :4317"
INVENTORY_API  --> JAEGER : "OTLP :4317"
ORDERS_API     --> JAEGER : "OTLP :4317"
DELIVERIES_API --> JAEGER : "OTLP :4317"
CAMPAIGNS_API  --> JAEGER : "OTLP :4317"

PROM   --> GRAFANA : "datasource"
JAEGER --> GRAFANA : "datasource"

' ── Notas ───────────────────────────────────────────────────────
note right of KAFKA
  Kafka KRaft (sin Zookeeper).
  Topics auto-creados: order.created,
  payment.succeeded, stock.reserved,
  entrega.programada, campana.activada,
  user.registered.
  Replication factor = 1 (dev).
end note

note left of TRAEFIK
  Traefik es el único punto de entrada
  expuesto: HTTP :80 y Dashboard :8080.
  Enruta /api/* a los microservicios
  con middlewares StripPrefix + AddPrefix.
  El tráfico restante (/) va a Next.js :3000.
  Web UI de Traefik en :8080.
end note

note left of FRONT
  Next.js standalone (puerto 3000 interno).
  Sin Nginx embebido.
  Red interna: gRPC para RPC síncrono,
  Kafka para eventos asíncronos.
end note

note bottom of MINIO
  Un solo MinIO compartido con
  5 buckets creados por minio-init.
end note

@enduml